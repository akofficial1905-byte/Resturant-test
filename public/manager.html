<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>YOUR RESTAURANT NAME â€” Manager Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .order-type-badge { font-size:12px; font-weight:bold; border-radius:7px; padding:2px 8px; margin-right:6px }
    .order-type-dinein { background:#fbbf24; color:#222; }
    .order-type-takeaway { background:#34d399; color:#222; }
    .order-type-delivery { background:#60a5fa; color:#fff; }
    .card-btn { transition: transform 0.1s; }
    .card-btn:hover { transform: scale(1.05); }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-900 via-gray-900 to-black text-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-4xl font-extrabold text-amber-300 mb-6">YOUR RESTAURANT NAME â€” Manager Portal</h1>
    <div class="bg-gray-800 rounded-2xl p-4 mb-6 flex justify-between items-center">
      <div>
        <label class="text-sm text-gray-400 mr-2">Select Date:</label>
        <input id="datePicker" type="date" class="bg-gray-900 border border-gray-700 p-2 rounded" />
      </div>
      <div class="flex flex-col text-right gap-2">
        <div class="text-sm text-gray-400">Total Orders: <span id="totalOrders" class="font-bold text-amber-300">0</span></div>
        <div class="text-sm text-gray-400">Revenue: â‚¹<span id="totalRevenue" class="font-bold text-green-300">0</span></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section>
        <h2 class="text-xl font-semibold text-amber-200 mb-4">Incoming Orders</h2>
        <div id="incoming" class="space-y-4"></div>
      </section>
      <section>
        <h2 class="text-xl font-semibold text-green-300 mb-4">Delivered Orders</h2>
        <div id="delivered" class="space-y-4"></div>
      </section>
    </div>
  </div>

  <script>
    const socket = io();
    const datePicker = document.getElementById('datePicker');
    datePicker.value = new Date().toISOString().slice(0,10);

    // ---------- Fetch Orders ----------
    async function fetchOrders(date) {
      try {
        const res = await fetch('/api/orders?date=' + date);
        const orders = await res.json();
        render(orders);
      } catch (err) {
        console.error('Error fetching orders', err);
      }
    }

    // ---------- Render Orders ----------
    function render(orders) {
      document.getElementById('totalOrders').innerText = orders.length;
      document.getElementById('totalRevenue').innerText = orders.reduce((s,o)=>s+o.total,0);

      const incoming = orders.filter(o => o.status !== 'delivered' && o.status !== 'deleted');
      const delivered = orders.filter(o => o.status === 'delivered');

      document.getElementById('incoming').innerHTML = incoming.map(o => `
        <div class="bg-gray-900 rounded-lg border border-amber-400 p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <span class="order-type-badge order-type-${o.orderType}">
                ${o.orderType.charAt(0).toUpperCase() + o.orderType.slice(1)}
              </span>
              <span class="font-bold text-lg">${o.customerName}</span>
              <div class="text-xs text-gray-400">${new Date(o.createdAt).toLocaleString()}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-amber-200">â‚¹${o.total}</div>
            </div>
          </div>
          <ul class="mt-3 text-sm text-gray-200">
            ${o.items.map(it => `â€¢ ${it.qty} Ã— ${it.name} â€” â‚¹${it.price}`).join('<br>')}
          </ul>
          <div class="mt-3 flex gap-2">
            <button class="card-btn px-3 py-1 bg-green-600 rounded" onclick="updateStatus('${o._id}','delivered')">Delivered</button>
            <button class="card-btn px-3 py-1 bg-amber-400 text-black rounded font-bold" onclick='printViaBluetooth(${JSON.stringify(o)})'>Bluetooth Print</button>
          </div>
        </div>
      `).join('');

      document.getElementById('delivered').innerHTML = delivered.map(o => `
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <span class="order-type-badge order-type-${o.orderType}">
                ${o.orderType.charAt(0).toUpperCase() + o.orderType.slice(1)}
              </span>
              <span class="font-bold text-lg">${o.customerName}</span>
              <div class="text-xs text-gray-400">${new Date(o.createdAt).toLocaleString()}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-green-300">â‚¹${o.total}</div>
            </div>
          </div>
          <ul class="mt-3 text-sm text-gray-300">
            ${o.items.map(it => `â€¢ ${it.qty} Ã— ${it.name} â€” â‚¹${it.price}`).join('<br>')}
          </ul>
          <div class="mt-3 flex gap-2">
            <button class="card-btn px-3 py-1 bg-teal-400 text-black rounded font-bold" onclick='printViaBluetooth(${JSON.stringify(o)})'>Bluetooth Print</button>
          </div>
        </div>
      `).join('');
    }

    // ---------- Status Updates ----------
    async function updateStatus(id, status) {
      await fetch('/api/orders/' + id + '/status', {
        method: 'PATCH',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ status })
      });
    }

    // ---------- Bluetooth Printing ----------
    let printerCharacteristic = null;
    async function connectBluetoothPrinter() {
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'Bluetooth Printer' }],
        optionalServices: [0xFFE0]
      });
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(0xFFE0);
      printerCharacteristic = await service.getCharacteristic(0xFFE1);
      alert('âœ… Bluetooth Printer connected!');
      return printerCharacteristic;
    }

    async function printViaBluetooth(order) {
      try {
        if (!('bluetooth' in navigator)) {
          alert('âš ï¸ Bluetooth not supported in this browser. Use Chrome/Edge on Android.');
          return;
        }
        if (!printerCharacteristic) await connectBluetoothPrinter();

        let receipt =
          '\x1B\x40' + '\x1B\x61\x01' + // init + center
          'YOUR RESTAURANT NAME\n' +
          '------------------------------\n' +
          '\x1B\x61\x00' +
          `Order Type: ${order.orderType}\nCustomer: ${order.customerName}\n` +
          (order.tableNumber ? `Table: ${order.tableNumber}\n` : '') +
          (order.address ? `Address: ${order.address}\n` : '') +
          '------------------------------\n' +
          order.items.map(it => `${it.qty} x ${it.name} - â‚¹${it.price}`).join('\n') +
          '\n------------------------------\n' +
          `Total: â‚¹${order.total}\nStatus: ${order.status}\n` +
          `${new Date(order.createdAt).toLocaleString()}\n\n` +
          'Thank you! Visit Again!\n\n\n';

        const encoder = new TextEncoder();
        await printerCharacteristic.writeValue(encoder.encode(receipt));
        alert('ðŸ–¨ï¸ Printed successfully!');
      } catch (e) {
        alert('âŒ Print failed: ' + (e.message || e));
      }
    }

    // ---------- Socket Live Updates ----------
    datePicker.onchange = () => fetchOrders(datePicker.value);
    socket.on('newOrder', o => {
      if ((o.createdAt || '').slice(0,10) === datePicker.value) fetchOrders(datePicker.value);
    });
    socket.on('orderUpdated', o => fetchOrders(datePicker.value));

    // ---------- Initial Load ----------
    fetchOrders(datePicker.value);
  </script>
</body>
</html>


