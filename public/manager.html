<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YOUR RESTAURANT NAME â€” Manager Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .order-type-badge { font-size:12px;font-weight:bold;border-radius:7px;padding:2px 8px;margin-right:6px }
    .order-type-dinein { background:#fbbf24;color:#222 }
    .order-type-takeaway { background:#34d399;color:#222 }
    .order-type-delivery { background:#60a5fa;color:#fff }
    .card-btn { transition:transform 0.1s }
    .card-btn:hover { transform:scale(1.05) }
    .insight-label { color:#b45309;font-weight:bold;font-size:1.13rem;letter-spacing:.8px }
    .insight-select,.insight-input {
      font-weight:bold;font-size:1.13rem;background:#fffbe8;color:#7c4700;
      border:2px solid #fbbf24;border-radius:6px;padding:6px 10px;
    }
    .insight-box {
      background:#fffbe8;border:3px solid #fbbf24;border-radius:16px;
      padding:24px;margin-top:16px;color:#4c1d06;font-size:1.13rem;
    }
    .insight-result-table th,.insight-result-table td {
      border-bottom:2px solid #fbbf24;padding:8px 12px!important;font-size:1.12em;
    }
    .insight-big-value { font-size:2em;font-weight:800;color:#a16207 }
    .insight-mid-value { font-size:1.15em;font-weight:700 }
    @media (max-width:768px){
      .mobile-hide{display:none}
    }
  </style>
</head>

<body class="bg-gradient-to-b from-slate-900 via-gray-900 to-black text-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-amber-300">YOUR RESTAURANT NAME â€” Manager</h1>
        <p class="text-sm text-gray-400">Contact: <b>+91-XXXXXXXXXX</b> â€¢ Manage Orders & Insights</p>
      </div>
      <a href="/index.html" class="px-4 py-2 bg-gray-800 rounded text-gray-200 text-sm md:text-base">Customer View</a>
    </header>

    <!-- DASHBOARD COLLAPSIBLE -->
    <div class="md:hidden mb-3">
      <button id="toggleDashboard" class="w-full bg-amber-400 text-black font-bold py-2 rounded shadow">
        ðŸ“Š Show Dashboard
      </button>
    </div>
    <section id="dashboard" class="bg-white rounded-xl p-6 mb-8 shadow-xl border border-gray-300 hidden md:block">
      <div class="flex flex-wrap gap-4 mb-4 items-center">
        <h2 class="text-2xl font-extrabold text-gray-800">ðŸ“Š Dashboard</h2>
        <label class="ml-4 insight-label">View:
          <select id="dashboardPeriod" class="ml-2 insight-select">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
          </select>
        </label>
        <label class="ml-4 insight-label">Date:
          <input id="dashboardDate" type="date" class="ml-2 insight-input" />
        </label>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-amber-50 border border-yellow-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-amber-700" id="sales-today">â‚¹0</div>
          <div class="text-xs mt-2 text-gray-700">Sales</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-green-700" id="orders-month">0</div>
          <div class="text-xs mt-2 text-gray-700">Orders</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-blue-700" id="peak-hour">-</div>
          <div class="text-xs mt-2 text-gray-700">Peak Hour</div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
          <div class="text-lg font-bold text-red-700" id="top-dish">-</div>
          <div class="text-xs mt-2 text-gray-700">Most Ordered</div>
        </div>
      </div>
    </section>

    <!-- INSIGHTS COLLAPSIBLE -->
    <div class="md:hidden mb-3">
      <button id="toggleInsights" class="w-full bg-yellow-400 text-black font-bold py-2 rounded shadow">
        ðŸ“ˆ Show Insights & Comparison
      </button>
    </div>
    <section id="insights" class="bg-white border-4 border-yellow-500 shadow-lg rounded-xl py-10 px-8 my-10 hidden md:block">
      <h3 class="text-2xl font-extrabold text-yellow-800 mb-7 tracking-wider">ðŸ“Š Detailed Insights & Comparison</h3>
      <form class="flex flex-wrap gap-7 items-center mb-4">
        <label class="insight-label">Insight:
          <select id="insightType" class="insight-select ml-1">
            <option value="compare_sales">Sales Comparison</option>
            <option value="repeat_customers">Repeat Customers</option>
            <option value="best_dish">Most Ordered Dish</option>
            <option value="customer_search">Customer Visits (by name)</option>
          </select>
        </label>
        <label id="compareByLabel" style="display:none;" class="insight-label ml-1">Compare by:
          <select id="compareBy" class="insight-select ml-1">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
          </select>
        </label>
        <label class="insight-label">First:
          <input type="date" id="insightFrom" class="insight-input ml-1"/>
        </label>
        <label class="insight-label">Second:
          <input type="date" id="insightTo" class="insight-input ml-1"/>
        </label>
        <input id="insightName" class="insight-input ml-1" style="display:none;" placeholder="Customer Name" />
        <button type="button" class="bg-yellow-400 hover:bg-yellow-500 text-black font-extrabold rounded px-5 py-2 ml-2 shadow-lg text-lg" onclick="runInsight()">Show</button>
      </form>
      <div id="insightResult" class="insight-box"></div>
    </section>

    <!-- ORDERS -->
    <div class="bg-gray-800 rounded-2xl p-4 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
      <div>
        <label class="text-sm text-gray-400 mr-2">Select Date:</label>
        <input id="datePicker" type="date" class="bg-gray-900 border border-gray-700 p-2 rounded" />
      </div>
      <div class="text-right text-sm text-gray-400">
        Total Orders: <span id="totalOrders" class="font-bold text-amber-300">0</span> |
        Revenue: â‚¹<span id="totalRevenue" class="font-bold text-green-300">0</span><br>
        <span class="order-type-badge order-type-dinein">Dine-in: <span id="countDinein">0</span></span>
        <span class="order-type-badge order-type-takeaway">Takeaway: <span id="countTakeaway">0</span></span>
        <span class="order-type-badge order-type-delivery">Delivery: <span id="countDelivery">0</span></span>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section>
        <h2 class="text-xl font-semibold text-amber-200 mb-4">Upcoming / Incoming Orders</h2>
        <div id="incoming" class="space-y-4"></div>
      </section>
      <section>
        <h2 class="text-xl font-semibold text-green-300 mb-4">Delivered Orders</h2>
        <div id="delivered" class="space-y-4"></div>
      </section>
    </div>
  </div>

  <script>
    const socket = io();
    const datePicker = document.getElementById('datePicker');
    datePicker.value = new Date().toISOString().slice(0,10);

    // --- Collapsible toggles ---
    document.getElementById('toggleDashboard').onclick = () => {
      const el = document.getElementById('dashboard');
      el.classList.toggle('hidden');
      document.getElementById('toggleDashboard').innerText =
        el.classList.contains('hidden') ? 'ðŸ“Š Show Dashboard' : 'ðŸ“‰ Hide Dashboard';
    };
    document.getElementById('toggleInsights').onclick = () => {
      const el = document.getElementById('insights');
      el.classList.toggle('hidden');
      document.getElementById('toggleInsights').innerText =
        el.classList.contains('hidden') ? 'ðŸ“ˆ Show Insights & Comparison' : 'ðŸ“‰ Hide Insights';
    };

    // --- Fetch Orders ---
    async function fetchOrders(date) {
      const res = await fetch('/api/orders?date=' + date);
      const orders = await res.json();
      render(orders);
    }

    function render(orders) {
      const dinein = orders.filter(o => o.orderType === 'dinein');
      const takeaway = orders.filter(o => o.orderType === 'takeaway');
      const delivery = orders.filter(o => o.orderType === 'delivery');
      document.getElementById('totalOrders').innerText = orders.length;
      document.getElementById('totalRevenue').innerText = orders.reduce((s,o)=>s+o.total,0);
      document.getElementById('countDinein').innerText = dinein.length;
      document.getElementById('countTakeaway').innerText = takeaway.length;
      document.getElementById('countDelivery').innerText = delivery.length;

      const incoming = orders.filter(o => o.status !== 'delivered' && o.status !== 'deleted');
      const delivered = orders.filter(o => o.status === 'delivered');

      document.getElementById('incoming').innerHTML = incoming.map(o => `
        <div class="bg-gray-900 rounded-lg border border-amber-400 p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <span class="order-type-badge order-type-${o.orderType}">${o.orderType.toUpperCase()}</span>
              <span class="font-bold text-lg">${o.customerName}</span>
              <div class="text-xs text-gray-400">${new Date(o.createdAt).toLocaleString()}</div>
              <div class="text-xs text-gray-400 mt-1">${renderOrderDetails(o)}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-amber-200">â‚¹${o.total}</div>
              <div class="text-xs text-gray-400">${o.mobile ? "ðŸ“± " + o.mobile : ""}</div>
            </div>
          </div>
          <ul class="mt-3 text-sm text-gray-200">
            ${o.items.map(it=>`<li>â€¢ ${it.qty} Ã— ${it.name} â€” â‚¹${it.price}</li>`).join('')}
          </ul>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button class="card-btn px-3 py-1 bg-green-600 rounded" onclick="updateStatus('${o._id}','delivered')">Delivered</button>
            <button class="card-btn px-3 py-1 bg-red-600 rounded" onclick="deleteOrder('${o._id}')">Delete</button>
            <button class="card-btn px-3 py-1 bg-teal-400 text-black rounded font-bold" onclick='printViaBluetooth(${JSON.stringify(o)})'>Bluetooth Print</button>
          </div>
        </div>`).join('');

      document.getElementById('delivered').innerHTML = delivered.map(o => `
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <span class="order-type-badge order-type-${o.orderType}">${o.orderType.toUpperCase()}</span>
              <span class="font-bold text-lg">${o.customerName}</span>
              <div class="text-xs text-gray-400">${new Date(o.createdAt).toLocaleString()}</div>
              <div class="text-xs text-gray-400 mt-1">${renderOrderDetails(o)}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-green-300">â‚¹${o.total}</div>
              <div class="text-xs text-gray-400">${o.mobile ? "ðŸ“± " + o.mobile : ""}</div>
            </div>
          </div>
          <ul class="mt-3 text-sm text-gray-300">
            ${o.items.map(it=>`<li>â€¢ ${it.qty} Ã— ${it.name} â€” â‚¹${it.price}</li>`).join('')}
          </ul>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button class="card-btn px-3 py-1 bg-teal-400 text-black rounded font-bold" onclick='printViaBluetooth(${JSON.stringify(o)})'>Bluetooth Print</button>
          </div>
        </div>`).join('');
    }

    function renderOrderDetails(o){
      if(o.orderType==='dinein') return `Table: ${o.tableNumber||'â€”'}`;
      else if(o.orderType==='takeaway'||o.orderType==='delivery') return `Address: ${o.address||'â€”'}`;
      return '';
    }

    async function updateStatus(id,status){
      await fetch('/api/orders/'+id+'/status',{
        method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status})
      });
    }

    async function deleteOrder(id){
      if(!confirm('Delete this order?'))return;
      await fetch('/api/orders/'+id+'/status',{
        method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'deleted'})
      });
    }

    // ---- Bluetooth Print (RawBT compatible) ----
    async function printViaBluetooth(order){
      try{
        let receipt=`YOUR RESTAURANT NAME\n------------------------------\n`;
        receipt+=`Order Type: ${order.orderType}\nCustomer: ${order.customerName}\n`;
        if(order.tableNumber) receipt+=`Table: ${order.tableNumber}\n`;
        if(order.address) receipt+=`Address: ${order.address}\n`;
        receipt+='------------------------------\n';
        order.items.forEach(it=>{
          receipt+=`${it.qty}x ${it.name}\nâ‚¹${it.price}\n`;
        });
        receipt+='------------------------------\n';
        receipt+=`TOTAL: â‚¹${order.total}\nSTATUS: ${order.status}\n${new Date(order.createdAt).toLocaleString()}\n\nThank You!\n\n`;

        // Send to RawBT
        const printURL=`intent://print/#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;end;`;
        const blob=new Blob([receipt],{type:'text/plain'});
        const blobUrl=URL.createObjectURL(blob);
        window.open(printURL+blobUrl,'_blank');
      }catch(e){
        alert('Bluetooth Print failed: '+(e.message||e));
      }
    }

    // ---- Dashboard ----
    const dashboardPeriod=document.getElementById('dashboardPeriod');
    const dashboardDate=document.getElementById('dashboardDate');
    dashboardDate.value=new Date().toISOString().slice(0,10);

    async function renderDashboard(){
      let d=dashboardDate.value,period=dashboardPeriod.value;
      let r=await fetch(`/api/dashboard/sales?period=${period}&date=${d}`);let stats=await r.json();
      document.getElementById('sales-today').textContent='â‚¹'+(stats.total||0);
      document.getElementById('orders-month').textContent=stats.count||0;
      r=await fetch(`/api/dashboard/peakhour?date=${d}`);let peak=await r.json();
      document.getElementById('peak-hour').textContent=peak?`${peak._id.hour}:00`:'-';
      r=await fetch(`/api/dashboard/topdish?date=${d}`);let dish=await r.json();
      document.getElementById('top-dish').textContent=dish?dish._id:'-';
    }
    dashboardPeriod.onchange=dashboardDate.onchange=renderDashboard;
    window.addEventListener('DOMContentLoaded',renderDashboard);

    // ---- Insights ----
    const compareBy=document.getElementById('compareBy');
    const compareByLabel=document.getElementById('compareByLabel');
    const insightType=document.getElementById('insightType');
    const insightName=document.getElementById('insightName');
    let myCustomChart=null;
    insightType.onchange=()=>{
      compareByLabel.style.display=insightType.value==='compare_sales'?'':'none';
      insightName.style.display=insightType.value==='customer_search'?'':'none';
    };

    async function runInsight(){
      const type=insightType.value,from=document.getElementById('insightFrom').value,
        to=document.getElementById('insightTo').value,name=insightName.value,by=compareBy.value;
      let html='';
      if(type==='compare_sales'){
        let salesA,salesB,labelA,labelB;
        if(by==='day'){
          salesA=await fetch(`/api/dashboard/sales?period=day&date=${from}`).then(r=>r.json());
          salesB=await fetch(`/api/dashboard/sales?period=day&date=${to}`).then(r=>r.json());
          labelA=from;labelB=to;
        }else if(by==='week'){
          salesA=await fetch(`/api/dashboard/sales?period=week&date=${from}`).then(r=>r.json());
          salesB=await fetch(`/api/dashboard/sales?period=week&date=${to}`).then(r=>r.json());
          labelA=`Week of ${from}`;labelB=`Week of ${to}`;
        }else{
          salesA=await fetch(`/api/dashboard/sales?period=month&date=${from}`).then(r=>r.json());
          salesB=await fetch(`/api/dashboard/sales?period=month&date=${to}`).then(r=>r.json());
          labelA=`Month: ${from.slice(0,7)}`;labelB=`Month: ${to.slice(0,7)}`;
        }
        html=`<div class="mb-6 flex items-center gap-10 flex-wrap">
          <div class="bg-yellow-200 rounded-xl p-4 shadow insight-big-value">${labelA}<br>â‚¹${salesA.total||0}<br><span class="insight-mid-value">Orders: ${salesA.count||0}</span></div>
          <div class="bg-yellow-200 rounded-xl p-4 shadow insight-big-value">${labelB}<br>â‚¹${salesB.total||0}<br><span class="insight-mid-value">Orders: ${salesB.count||0}</span></div>
        </div>
        <canvas id="myChart" width="400" height="180"></canvas>`;
        setTimeout(()=>{renderChart([labelA,labelB],[salesA.total,salesB.total],'Sales Comparison');},100);
      }else if(type==='repeat_customers'){
        const data=await fetch(`/api/dashboard/repeatcustomers?from=${from}&to=${to}`).then(r=>r.json());
        html=`<table class="insight-result-table w-full"><thead><tr><th>Name</th><th>Orders</th></tr></thead><tbody>`+
        data.map(c=>`<tr><td>${c._id}</td><td>${c.orders}</td></tr>`).join('')+`</tbody></table>`;
      }else if(type==='best_dish'){
        const dish=await fetch(`/api/dashboard/topdish?from=${from}&to=${to}`).then(r=>r.json());
        html=dish?`<div class="text-2xl font-bold text-yellow-800 mb-2">${dish._id}</div><div class="text-lg">Total Orders: <b>${dish.count}</b></div>`:'<div>No data found</div>';
      }else if(type==='customer_search'&&name){
        const data=await fetch(`/api/dashboard/repeatcustomers?from=${from}&to=${to}&name=${encodeURIComponent(name)}`).then(r=>r.json());
        html=data&&data.length?`<div class="text-2xl text-yellow-900 font-bold mb-2">${name} visited <b>${data[0].orders}</b> times</div>`:`<div>${name} did not visit.</div>`;
      }
      document.getElementById('insightResult').innerHTML=html;
    }

    function renderChart(labels,data,label){
      const ctx=document.getElementById('myChart').getContext('2d');
      if(myCustomChart)myCustomChart.destroy();
      myCustomChart=new Chart(ctx,{
        type:'bar',
        data:{labels:labels,datasets:[{label:label,data:data,backgroundColor:'rgba(251,191,36,0.7)',borderColor:'rgba(251,191,36,1)',borderWidth:2}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
      });
    }

    // --- Live updates ---
    datePicker.onchange=()=>fetchOrders(datePicker.value);
    socket.on('newOrder',o=>{
      if((o.createdAt||'').slice(0,10)===datePicker.value)fetchOrders(datePicker.value);
    });
    socket.on('orderUpdated',()=>fetchOrders(datePicker.value));
    fetchOrders(datePicker.value);
  </script>
</body>
</html>
